on:
  workflow_call: 
    inputs: 
      dotnet-version:
        required: false
        default: '7.x.x'
        type: string
      publish-directory:
        required: false
        default: 'publish/data'
        type: string
      migrations-project:
        required: true
        type: string

jobs:
  generate-semver:
    runs-on: ubuntu-latest
    outputs:
      semver: ${{ steps.fullsemver.outputs.semver }}
    steps:
      - name: âœ… Checkout
        uses: actions/checkout@v3

      - name: âš™ï¸ Generate SemVersion
        id: semver
        uses: paulhatch/semantic-version@v5.3.0

      - name: âš™ï¸ Set SemVersion output
        id: fullsemver
        run: |
          if [ ${{ github.ref_name }} != 'main' ]; then
            echo "semver=${{ steps.semver.outputs.version }}-${{ github.run_id }}.${{ github.run_number }}" >> "$GITHUB_OUTPUT"
          else
            echo "semver=${{ steps.semver.outputs.version }}" >> "$GITHUB_OUTPUT"
          fi
          
  build-data:
      needs: generate-semver
      runs-on: ubuntu-latest
      env:
        version: ${{ needs.generate-semver.outputs.semver }}
      steps:
        - name: âœ… Checkout 
          uses: actions/checkout@v3
          
        - name: âš™ï¸ Setup .NET Core SDK ${{ inputs.dotnet-version }}
          uses: actions/setup-dotnet@v3
          with:
            dotnet-version: ${{ inputs.dotnet-version }}
        
        - name: Restore
          run: dotnet restore
        
        - name: ğŸ”¨ Build
          run: dotnet build --configuration Release --no-restore      
       
        - name: ğŸ”¨ Install EF Core tool
          run: dotnet tool install --global dotnet-ef
          
        - name: ğŸ”¨ Generate EF core sql migration script
          run: dotnet ef migrations script --idempotent --project ${{ inputs.migrations-project }} --output ${{ inputs.publish-directory }}/${{ env.version }}.sql
       
        - name: ğŸ“¡ Upload data artifact
          uses: actions/upload-artifact@v2
          with: 
            name: data
            path: ${{ inputs.publish-directory }}